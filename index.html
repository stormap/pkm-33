<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PKM Battle System - Switch Style</title>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,700;0,800;0,900;1,900&family=Rubik:ital,wght@0,400;0,500;0,700;0,900;1,700&family=M+PLUS+Rounded+1c:wght@500;700;800;900&family=Zhi+Mang+Xing&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./index.css">
    <link rel="stylesheet" href="./cmd/styles.css">
    <link rel="stylesheet" href="./cmd/theme-update.css">
    <script type="module" src="./src/main.js"></script>
</head>
<body>
    <svg style="position: absolute; width: 0; height: 0; overflow: hidden;" aria-hidden="true">
        <defs>
            <linearGradient id="mega-rainbow" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#ff9cd6" />
                <stop offset="25%" style="stop-color:#ffeb3b" />
                <stop offset="50%" style="stop-color:#5affda" />
                <stop offset="75%" style="stop-color:#4bcffa" />
                <stop offset="100%" style="stop-color:#d49bfd" />
            </linearGradient>

            <filter id="tera-shatter-filter" color-interpolation-filters="sRGB">
                <feTurbulence type="fractalNoise" baseFrequency="0.03" numOctaves="3" result="fractal" />
                <feTurbulence type="turbulence" baseFrequency="0.05" numOctaves="2" seed="5" result="noise" />
                <feDisplacementMap in="SourceGraphic" in2="noise" scale="3" xChannelSelector="R" yChannelSelector="G" result="displaced"/>
                <feSpecularLighting in="fractal" surfaceScale="3" specularConstant="0.5" specularExponent="30" lighting-color="#ffffff" result="specular">
                    <fePointLight x="-5000" y="-10000" z="20000"/>
                </feSpecularLighting>
                <feComposite in="specular" in2="displaced" operator="in" result="specular-masked"/>
                <feComposite in="specular-masked" in2="displaced" operator="lighter" result="lighter-composite"/>
                <feMerge>
                    <feMergeNode in="displaced" />
                    <feMergeNode in="lighter-composite" />
                </feMerge>
            </filter>
            <filter id="crystal-gloss" x="-20%" y="-20%" width="140%" height="140%">
                <feGaussianBlur in="SourceAlpha" stdDeviation="2.5" result="blur"/>
                <feSpecularLighting in="blur" surfaceScale="6" specularConstant="1" specularExponent="35" lighting-color="#ffffff" result="specOut">
                    <fePointLight x="-50" y="-100" z="200" />
                </feSpecularLighting>
                <feComposite in="specOut" in2="SourceAlpha" operator="in" result="specOut"/>
                <feComposite in="SourceGraphic" in2="specOut" operator="arithmetic" k1="0" k2="1" k3="1" k4="0"/>
            </filter>
        </defs>
    </svg>

    <div class="ui-root" id="ui-root">
        <div class="ui-scale" id="ui-scale">

            <div class="screen-filters"></div>

            <div class="bg-gradient"></div>

            <div id="start-view" class="overlay-screen">
                <div class="start-card">
                    <h1 class="logo-title">BATTLE <span class="accent">LINK</span></h1>
                    <div class="loader-notch"></div>
                    <p class="sys-msg">PRESS START TO INITIALIZE</p>
                    <button class="start-btn" onclick="initGame()" id="btn-start" disabled>ƒêang k·∫øt n·ªëi...</button>
                </div>
            </div>

            <div id="game-view" class="game-container hidden">
                <div class="battle-stage">
                    <canvas id="weather-canvas" width="1100" height="720"></canvas>
                    
                    <div id="insight-bar" class="insight-bar">
                        <div class="insight-bar-fill" style="width: 0%;"></div>
                        <div class="insight-bar-text">Tr·ª±c gi√°c: 0</div>
                    </div>
                    
                    
                    <div class="trainer-hud hidden" id="trainer-hud">
                        <div class="trainer-panel">
                            <div class="trainer-panel-content">
                                <div class="trainer-name" id="trainer-name">TRAINER</div>
                            </div>
                        </div>
                        <div class="trainer-avatar-wrap">
                            <img id="trainer-avatar" alt="trainer" />
                        </div>
                    </div>

                    <div class="hud container-enemy">
                        <div class="party-track enemy-side" id="ui-enemy-dots"></div>

                        <div class="sharp-panel panel-enemy-bg">
                            <div class="panel-content unskew">
                                <div class="sw-top-row">
                                    <span class="p-name" id="enemy-name">Pokemon</span>
                                    <span class="p-lv">Lv.<span id="enemy-lvl">50</span></span>
                                </div>
                                <div class="hp-track-wrappersw">
                                    <div class="hp-border-frame">
                                        <div class="hp-fill-colors" id="enemy-hp-fill" style="width: 100%;"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="deco-strip enemy"></div>
                        </div>
                    </div>

                    <div class="sprite-wrapper enemy-pos">
                        <img id="enemy-sprite" class="p-sprite" src="" alt="">
                        <div class="shadow-base"></div>
                    </div>

                    <div class="sprite-wrapper player-pos">
                        <img id="player-sprite" class="p-sprite player-scale" src="" alt="">
                        <div class="shadow-base"></div>
                    </div>

                    <div class="hud container-player">
                        <div class="sharp-panel panel-player-bg">
                            <div class="panel-content unskew">
                                <div class="sw-top-row">
                                    <span class="p-name" id="player-name">Pokemon</span>
                                    <div class="sw-row-right-group">
                                        <span class="hp-v-nums" id="player-hp-txt">--/--</span>
                                        <span class="p-lv">Lv.<span id="player-lvl">80</span></span>
                                    </div>
                                </div>
                                <div class="hp-track-wrappersw">
                                    <div class="hp-border-frame bg-player">
                                        <div class="hp-fill-colors" id="player-hp-fill" style="width: 100%;"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="deco-strip player"></div>
                        </div>

                        <div class="party-track player-side" id="ui-player-dots"></div>
                    </div>
                </div>

                <div id="smart-bubble" class="smart-bubble-wrapper" onclick="toggleCommanderRoot()">
                    <div class="bubble-glow-ring"></div>
                    <div class="bubble-core">
                        <div class="bubble-icon-stage" id="bubble-icon-stage"></div>
                    </div>
                    <div class="bubble-label-pill" id="bubble-text">LINK</div>
                    <svg class="bubble-progress" viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="46" stroke-width="4" stroke="rgba(255,255,255,0.1)" fill="none"></circle>
                        <circle id="bubble-timer-circle" cx="50" cy="50" r="46" stroke-width="4" stroke="currentColor" fill="none" stroke-dasharray="289" stroke-dashoffset="0"></circle>
                    </svg>
                </div>

                <div id="commander-overlay" class="cmd-layer hidden">
                    <div class="commander-container">
                        <div class="commander-wheel" id="cmd-wheel">
                            <button class="cmd-btn pos-top" id="slot-top" onclick="handleQuadrant('top')">
                                <svg class="icon-bg" viewBox="0 0 100 100"></svg>
                                <div class="cmd-content">
                                    <span class="cmd-label">---</span>
                                    <span class="cmd-sub">---</span>
                                </div>
                            </button>

                            <button class="cmd-btn pos-right" id="slot-right" onclick="handleQuadrant('right')">
                                <svg class="icon-bg" viewBox="0 0 100 100"></svg>
                                <div class="cmd-content">
                                    <span class="cmd-label">---</span>
                                    <span class="cmd-sub">---</span>
                                </div>
                            </button>

                            <button class="cmd-btn pos-bottom" id="slot-bottom" onclick="handleQuadrant('bottom')">
                                <svg class="icon-bg" viewBox="0 0 100 100"></svg>
                                <div class="cmd-content">
                                    <span class="cmd-label">---</span>
                                    <span class="cmd-sub">---</span>
                                </div>
                            </button>

                            <button class="cmd-btn pos-left" id="slot-left" onclick="handleQuadrant('left')">
                                <svg class="icon-bg" viewBox="0 0 100 100"></svg>
                                <div class="cmd-content">
                                    <span class="cmd-label">---</span>
                                    <span class="cmd-sub">---</span>
                                </div>
                            </button>

                            <div class="cmd-hub">
                                <div class="pulse-ring"></div>
                            </div>
                        </div>

                        <div class="cmd-cancel-hint" onclick="handleCloseOrBack()">
                            <span class="key" id="cancel-key-text">X</span>
                            <span id="cancel-text">ƒê√≥ng l·ªánh</span>
                        </div>
                    </div>
                </div>

                <div class="command-dashboard">
                    <div class="msg-box-modern">
                        <div class="msg-header">
                            <span class="sys-label">BATTLE LOG</span>
                            <div class="sys-dots">
                                <span></span><span></span><span></span>
                            </div>
                        </div>
                        <div class="msg-content-area" id="log-box"></div>
                        <div class="next-cursor"></div>
                    </div>

                    <div class="main-menu" id="main-menu">
                        <div class="radical-menu-container">
                            <button class="radical-btn btn-fight" id="btn-fight" onclick="showMovesMenu()">
                                <div class="skew-fix">
                                    <div class="r-icon-bg"></div>
                                    <svg class="r-icon" viewBox="0 0 256 256" fill="currentColor" aria-hidden="true">
                                        <path d="M168,16H120A56,56,0,0,0,64,72v31.73A8.17,8.17,0,0,1,56.53,112,8,8,0,0,1,48,104V78.7a4,4,0,0,0-5.63-3.65A32,32,0,0,0,24,104v29.19a16.14,16.14,0,0,0,3.5,10q.3.36.63.69L64,179.34V216a16,16,0,0,0,16,16H192a16,16,0,0,0,16-16V177.12l15.38-53.84a16,16,0,0,0,.62-4.4V72A56,56,0,0,0,168,16Zm3.58,168.84a8,8,0,0,1-7.16,14.32L136,184.94l-28.42,14.22a8,8,0,1,1-7.16-14.32L118.11,176l-17.69-8.84a8,8,0,1,1,7.16-14.32L136,167.06l28.42-14.22a8,8,0,1,1,7.16,14.32L153.89,176Z"/>
                                    </svg>
                                    <div class="r-label">
                                        <span class="en">FIGHT</span>
                                        <span class="jp">Chi·∫øn ƒë·∫•u</span>
                                    </div>
                                </div>
                            </button>

                            <div class="radical-sub-group" id="menu-right-col">
                                <button class="radical-btn btn-catch hidden" id="btn-catch" onclick="openBallMenu()">
                                    <div class="skew-fix">
                                        <svg class="r-icon small" viewBox="0 0 100 125">
                                            <g><path d="M50,70.2c-9.2,0-16.9-6.4-19-14.9H6.6c2.3,21.9,20.8,39,43.4,39s41.1-17.1,43.4-39H68.9C66.9,63.8,59.2,70.2,50,70.2z"/></g><circle cx="50" cy="50.7" r="12"/><path d="M30.9,46C33,37.4,40.7,31,50,31S67,37.4,69,46h24.5c-0.4-4.1-1.4-8-2.9-11.6c0.5-0.7,0.9-1.5,1.1-2.4c0.5-1.9,0.1-4-0.9-5.8  c-3.6-6-9.8-12.2-13.8-15c-1.2-0.9-2.6-1.4-4.1-1.4h0c-1.5,0-2.8,0.5-3.9,1.4C63.3,8.4,56.8,6.8,50,6.8c-6.8,0-13.3,1.6-19.1,4.4  c-1.1-0.9-2.5-1.4-3.9-1.4c-1.5,0-2.9,0.5-4.1,1.4c-4,2.9-10.2,9.1-13.8,15C8,28,7.6,30.1,8.1,32c0.2,0.9,0.6,1.7,1.1,2.4  C7.8,38.1,6.8,42,6.4,46H30.9z M68,24.7C68,24.7,68,24.7,68,24.7l4-9c0.2-0.4,0.6-0.6,1-0.6c0.3,0,0.7,0.1,1,0.4  c3.7,2.6,9.4,8.5,12.5,13.5c0.6,1.1,0.5,2.3-0.4,2.8l-6.5,3.8c-0.3,0.2-0.6,0.2-0.9,0.2c-0.5,0-1.1-0.2-1.4-0.7  c-2.4-3.2-5.3-6-8.5-8.4C68,26.2,67.7,25.4,68,24.7z M13.5,29c3.1-5.1,8.7-10.9,12.5-13.5c0.3-0.2,0.7-0.4,1-0.4  c0.4,0,0.8,0.2,1,0.6l4,9c0,0,0,0,0,0c0.3,0.7,0,1.6-0.6,2c-3.2,2.4-6.1,5.2-8.5,8.4c-0.3,0.5-0.9,0.7-1.4,0.7  c-0.3,0-0.6-0.1-0.9-0.2L14,31.8C13.1,31.2,12.9,30,13.5,29z"/>
                                        </svg>
                                        <span class="r-label-min">CATCH</span>
                                    </div>
                                </button>

                                <button class="radical-btn btn-pokemon" id="btn-pokemon" onclick="renderSwitchMenu()">
                                    <div class="skew-fix">
                                        <svg class="r-icon small" viewBox="22 28 56 48" fill="currentColor" aria-hidden="true">
                                            <path fill-rule="evenodd" d="m50.004 29.184c10.695 0 19.656 8.0234 20.699 18.609h-13.609c-0.92969-3.0234-3.7188-5.2383-7.0938-5.2383-3.3711 0-6.1602 2.2148-7.0938 5.2383h-13.605c1.1641-10.586 10.113-18.609 20.703-18.609zm0 16.512c2.4453 0 4.4219 1.8594 4.4219 4.3047s-1.9766 4.4219-4.4219 4.4219c-2.4414 0-4.3047-1.9766-4.3047-4.4219 0-2.4414 1.8594-4.3047 4.3047-4.3047zm20.695 6.5195c-1.0391 10.582-10 18.602-20.695 18.602-10.586 0-19.535-8.0234-20.703-18.605l13.609 0.003906c0.92969 3.0195 3.7188 5.2305 7.0938 5.2305s6.1602-2.2148 7.0938-5.2305z"/>
                                        </svg>
                                        <span class="r-label-min">POK√âMON</span>
                                    </div>
                                </button>

                                <button class="radical-btn btn-run" id="btn-run" onclick="tryRun()">
                                    <div class="skew-fix">
                                        <svg class="r-icon small" viewBox="0 0 100 100" fill="currentColor" aria-hidden="true">
                                            <path d="M71.738,94.995c-0.03-0.001-0.06-0.001-0.091-0.003C71.677,94.993,71.707,94.994,71.738,94.995z"/>
                                            <path d="M27.068,30.372c-0.239,0.239-0.487,0.492-0.733,0.739c0.591-0.563,1.195-1.09,1.811-1.586   C27.785,29.797,27.425,30.075,27.068,30.372z"/>
                                            <path d="M71.04,22.853c0.205-0.186,0.396-0.385,0.586-0.585c-1.787,1.653-4.176,2.653-6.788,2.653   C67.283,24.92,69.351,24.17,71.04,22.853z"/>
                                            <path d="M72.329,43.413c-0.086,0.007-0.172,0.011-0.257,0.017C72.158,43.424,72.244,43.42,72.329,43.413z"/>
                                            <path d="M68.214,43.376c-0.211-0.02-0.422-0.037-0.634-0.062C67.791,43.339,68.002,43.357,68.214,43.376z"/>
                                            <path d="M75.362,32.625c-0.024,0.024-0.046,0.038-0.07,0.056c0.338-0.13,0.672-0.28,1.004-0.44   C75.986,32.385,75.674,32.514,75.362,32.625z"/>
                                            <path d="M73.767,43.251c-0.031,0.005-0.063,0.01-0.094,0.014C73.704,43.261,73.736,43.256,73.767,43.251z"/>
                                            <path d="M61.835,30.935c-0.189-0.188-0.566-0.375-0.755-0.375c0.229,0.135,0.455,0.249,0.683,0.375H61.835z"/>
                                            <path d="M83.421,39.525c-0.074,0.049-0.15,0.094-0.224,0.142C83.272,39.619,83.347,39.573,83.421,39.525z"/>
                                            <path d="M22.886,34.977c0.206-0.269,0.415-0.531,0.625-0.791C23.299,34.445,23.092,34.709,22.886,34.977z"/>
                                            <path d="M72.258,94.986c-0.013,0.001-0.026,0.001-0.04,0.002C72.231,94.988,72.244,94.987,72.258,94.986z"/>
                                            <path d="M75.362,93.888c0.108-0.108,0.202-0.228,0.299-0.345c-0.69,0.629-1.552,1.08-2.472,1.301   C73.965,94.666,74.711,94.34,75.362,93.888z"/>
                                            <path d="M57.136,62.318c-0.357-0.238-0.737-0.476-1.125-0.714c0.374,0.232,0.749,0.472,1.124,0.715L57.136,62.318z"/>
                                            <path d="M64.886,42.847c-0.578-0.132-1.156-0.275-1.736-0.448C63.73,42.571,64.309,42.717,64.886,42.847z"/>
                                            <path d="M66.597,43.174c-0.292-0.047-0.585-0.099-0.878-0.157C66.012,43.074,66.305,43.128,66.597,43.174z"/>
                                            <path d="M71.264,94.957c-0.061-0.008-0.123-0.013-0.184-0.023C71.141,94.943,71.203,94.949,71.264,94.957z"/>
                                            <path d="M72.81,94.923c-0.018,0.003-0.035,0.005-0.053,0.008C72.775,94.928,72.793,94.926,72.81,94.923z"/>
                                            <path d="M57.51,28.492c-6.577-3.946-13.152-5.073-19.166-3.946c0,0.028-0.012,0.046-0.019,0.067   C44.361,23.365,50.934,24.602,57.51,28.492z"/>
                                            <path d="M83.802,25.422c-0.12,0.078-0.24,0.159-0.356,0.249c-0.188,0.189-0.376,0.379-0.563,0.755   C83.163,26.033,83.474,25.704,83.802,25.422z"/>
                                            <path d="M67.471,92.197c0.797,1.594,2.056,2.43,3.417,2.698C69.545,94.619,68.287,93.777,67.471,92.197z"/>
                                            <path d="M58.457,7.356c-0.129,0.091-0.26,0.18-0.383,0.275c-0.288,0.288-0.557,0.6-0.815,0.921   C57.625,8.122,58.025,7.721,58.457,7.356z"/>
                                            <path d="M85.887,37.701c0.096-0.086,0.185-0.179,0.28-0.266c-0.174,0.15-0.345,0.31-0.521,0.455   C85.726,37.824,85.807,37.766,85.887,37.701z"/>
                                            <path d="M85.126,38.296c-0.26,0.204-0.524,0.399-0.788,0.591C84.603,38.697,84.865,38.498,85.126,38.296z"/>
                                            <path d="M76.43,32.178c0.233-0.115,0.465-0.231,0.694-0.361C76.894,31.944,76.662,32.068,76.43,32.178z"/>
                                            <path d="M83.802,25.422c-0.328,0.282-0.639,0.611-0.919,1.004c-1.759,2.44-3.692,4.217-5.758,5.391   c-0.229,0.13-0.462,0.246-0.694,0.361c-0.044,0.022-0.089,0.042-0.133,0.064c-0.332,0.16-0.666,0.31-1.004,0.44   c-4.132,1.583-8.728,0.912-13.529-1.746c-0.228-0.126-0.454-0.24-0.683-0.375c-0.563-0.376-3.007-1.881-3.57-2.069   c-6.576-3.889-13.15-5.126-19.185-3.879c-3.627,0.749-7.059,2.398-10.179,4.912c-0.616,0.496-1.22,1.023-1.811,1.586   c-0.979,0.933-1.921,1.96-2.824,3.076c-0.21,0.26-0.42,0.521-0.625,0.791c-0.302,0.396-0.601,0.801-0.893,1.218   c-3.757,5.263,5.075,10.337,8.647,5.077c4.695-6.578,10.523-8.458,16.914-6.391c-3.195,5.826-6.202,11.462-10.15,19.357   c-4.136,8.08-12.966,14.469-21.614,9.582c-6.198-3.757-11.649,5.263-5.635,8.834c11.837,6.764,25.557,2.631,32.509-6.202   c0.188,0,0.563,0.186,0.751,0.186c5.826,2.069,13.344,7.329,15.6,9.212c2.253,1.877,6.199,11.462,8.456,16.346   c0.815,1.58,2.074,2.422,3.417,2.698c0.064,0.013,0.127,0.028,0.191,0.039c0.061,0.01,0.123,0.015,0.184,0.023   c0.127,0.016,0.255,0.028,0.383,0.035c0.03,0.002,0.06,0.002,0.091,0.003c0.16,0.005,0.32,0.003,0.48-0.006   c0.013-0.001,0.026-0.001,0.04-0.002c0.167-0.011,0.334-0.029,0.5-0.056c0.018-0.003,0.036-0.005,0.053-0.008   c0.128-0.022,0.254-0.049,0.379-0.079c0.92-0.221,1.782-0.672,2.472-1.301c1.423-1.296,2.11-3.339,1.019-5.668   c-2.633-5.449-7.142-16.349-10.524-19.167c-2.064-1.515-5.539-4.134-9.022-6.388c-0.375-0.243-0.75-0.483-1.124-0.715   c-0.896-0.557-1.782-1.079-2.635-1.541c3.195-6.014,6.391-11.838,9.773-17.664c0.58,0.173,1.159,0.316,1.736,0.448   c0.278,0.064,0.555,0.116,0.833,0.17c0.293,0.057,0.586,0.11,0.878,0.157c0.328,0.053,0.656,0.101,0.983,0.14   c0.212,0.026,0.423,0.042,0.634,0.062c1.3,0.123,2.587,0.14,3.858,0.054c0.086-0.006,0.172-0.01,0.257-0.017   c0.45-0.036,0.898-0.085,1.344-0.147c0.031-0.004,0.063-0.01,0.094-0.014c3.309-0.475,6.481-1.674,9.43-3.585   c0.074-0.048,0.15-0.093,0.224-0.142c0.308-0.204,0.613-0.418,0.917-0.638c0.265-0.192,0.528-0.387,0.788-0.591   c0.173-0.136,0.348-0.266,0.52-0.407c0.176-0.145,0.347-0.305,0.521-0.455c1.915-1.652,3.716-3.619,5.359-5.936   C95.002,26.631,87.866,21.929,83.802,25.422z"/>
                                            <path d="M64.838,24.92c2.612,0,5.001-0.999,6.788-2.653c1.943-1.798,3.174-4.37,3.174-7.307c0-5.448-4.511-9.958-9.962-9.958   c-2.417,0-4.645,0.891-6.381,2.354c-0.432,0.365-0.833,0.765-1.199,1.197c-1.476,1.74-2.376,3.979-2.376,6.408   C54.882,20.6,59.39,24.92,64.838,24.92z"/>
                                        </svg>
                                        <span class="r-label-min">ESCAPE</span>
                                    </div>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="moves-menu hidden" id="moves-menu">
                        <button class="action-btn" id="btn-m0" onclick="handleAttack(0)">
                            <span class="move-name">---</span>
                            <span class="move-type">---</span>
                        </button>
                        <button class="action-btn" id="btn-m1" onclick="handleAttack(1)">
                            <span class="move-name">---</span>
                            <span class="move-type">---</span>
                        </button>
                        <button class="action-btn" id="btn-m2" onclick="handleAttack(2)">
                            <span class="move-name">---</span>
                            <span class="move-type">---</span>
                        </button>
                        <button class="action-btn" id="btn-m3" onclick="handleAttack(3)">
                            <span class="move-name">---</span>
                            <span class="move-type">---</span>
                        </button>
                        <button class="back-btn-pill" id="btn-back" onclick="showMainMenu()" title="Back">
                            <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                                <path d="M19 11H7.83l4.88-4.88a1 1 0 0 0-1.42-1.42l-6.59 6.59a1 1 0 0 0 0 1.41l6.59 6.59a1 1 0 0 0 1.42-1.41L7.83 13H19a1 1 0 0 0 0-2z"/>
                            </svg>
                        </button>
                        <button class="mega-btn-pill hidden" id="btn-mega" onclick="toggleMega()" title="Mega Evolution">
                            <svg viewBox="0 0 100 100" class="mega-icon">
                                <circle cx="50" cy="50" r="42" stroke="currentColor" stroke-width="6" fill="none" opacity="0.4"/>
                                <text x="50" y="68" font-size="50" text-anchor="middle" fill="currentColor" font-weight="900" style="font-family: inherit;">M</text>
                            </svg>
                        </button>
                        <button class="mega-btn-pill evo-style hidden" id="btn-evolved" onclick="triggerBattleEvolution()" title="Evolution">
                            <div class="evo-particles"></div>
                            <span class="evo-text">EVO</span>
                        </button>
                    </div>
                </div>

                <div id="result-overlay" class="result-screen hidden">
                    <div class="res-modern-card" id="res-card-bg">
                        <div class="res-header-banner">
                            <div class="res-header-content">
                                <span class="res-flag">BATTLE RESULT</span>
                                <h1 class="res-big-title" id="res-title">VICTORY</h1>
                            </div>
                            <div class="res-header-pattern"></div>
                        </div>

                        <div class="res-rank-stamp-wrap">
                            <div class="res-rank-ring">
                                <span id="res-grade-letter">S</span>
                                <span id="res-grade-sub">RANK</span>
                            </div>
                        </div>

                        <div class="res-body">
                            <div class="res-info-grid">
                                <div class="res-info-tile full-width">
                                    <span class="tile-label">STATUS</span>
                                    <span class="tile-val major" id="col-status">Victory against Cynthia</span>
                                </div>
                                <div class="res-info-tile full-width description-tile">
                                    <span class="tile-icon">üí¨</span>
                                    <span class="tile-val text-desc" id="col-desc">M·ªôt chi·∫øn th·∫Øng √°p ƒë·∫£o ho√†n to√†n.</span>
                                </div>
                                <div class="res-info-tile team-tile">
                                    <span class="tile-label">PARTY</span>
                                    <div class="mini-party-dots" id="res-party-viz"></div>
                                </div>
                                <div class="res-info-tile">
                                    <span class="tile-label">REASON</span>
                                    <span class="tile-val" id="col-reason">Total Domination</span>
                                </div>
                            </div>
                            <textarea id="res-clipboard-text" readonly></textarea>
                        </div>

                        <div class="res-pills-action">
                            <button class="pill-btn restart" onclick="restartBattle()">
                                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" class="pill-icon">
                                    <path d="M4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4V2M12 4L8 8M12 4L16 8" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                RETRY
                            </button>
                            <button class="pill-btn sec" onclick="copyResultOnly()">
                                DATA ONLY
                            </button>
                            <button class="pill-btn primary" onclick="copyFullProcess()">
                                <span class="btn-text">COPY FULL LOG</span>
                                <span class="btn-sub">RP Mode</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="overlay-modal hidden" id="switch-menu-layer"></div>
                <div id="ball-layer" class="ball-menu-overlay hidden">
                    <div class="ball-menu-card">
                        <div class="ball-header">SELECT BALL</div>
                        <button class="ball-option" onclick="tryCatch(1)">
                            <span>Poke Ball</span> <span class="ball-multi">x1.0</span>
                        </button>
                        <button class="ball-option" onclick="tryCatch(1.5)">
                            <span>Great Ball</span> <span class="ball-multi">x1.5</span>
                        </button>
                        <button class="ball-option" onclick="tryCatch(2.0)">
                            <span>Ultra Ball</span> <span class="ball-multi">x2.0</span>
                        </button>
                        <button class="ball-option" style="border-color:#a855f7;color:#9333ea" onclick="tryCatch(255)">
                            <span style="font-weight:900">Master Ball</span> <span class="ball-multi" style="background:#9333ea">MAX</span>
                        </button>
                        <button class="close-ball-menu" onclick="closeBallMenu()">CANCEL</button>
                    </div>
                </div>
            </div>

            <div id="theater-layer" class="cutin-overlay pointer-events-none">
                <div id="cutin-stage" class="compact-bar hidden">
                    <div class="deco-edge"></div>
                    <div class="compact-content">
                        <div class="avatar-slot">
                            <img id="cutin-avatar" src="" class="c-avatar-img" alt="cutin avatar" onerror="this.style.opacity=0">
                        </div>
                        <div class="text-slot">
                            <div class="c-name-strip" id="cutin-name">TRAINER</div>
                            <div class="c-dialogue" id="cutin-text">Battle text goes here...</div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

<script>
    (function () {
        function handleInjectedData(data) {
            if (!data) return;
            window.globalBattleData = data;
            if (typeof window.onBattleDataInjected === 'function' && window.onBattleDataInjected !== handleInjectedData) {
                try {
                    window.onBattleDataInjected(data);
                } catch (e) {
                    console.warn('[PKM] onBattleDataInjected error:', e);
                }
            }
        }

        window.globalBattleData = window.globalBattleData || null;
        window.onBattleDataInjected = handleInjectedData;

        window.addEventListener('message', (event) => {
            const payload = event?.data;
            if (!payload || payload.type !== 'pkm-battle-data') return;
            handleInjectedData(payload.payload);
        });

        window.requestBattleDataFromParent = function () {
            if (window.parent && window.parent !== window) {
                try {
                    window.parent.postMessage({ type: 'pkm-battle-data-request' }, '*');
                } catch (e) {
                    console.warn('[PKM] requestBattleDataFromParent failed:', e);
                }
            }
        };

        window.requestBattleDataFromParent();
    })();
</script>
</body>
</html>